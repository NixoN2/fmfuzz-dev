name: Build Solver

on:
  workflow_call:
    inputs:
      solver:
        description: 'Solver name (must have solver.json config)'
        required: true
        type: string
      commit_hash:
        required: false
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_REGION:
        required: true
      AWS_S3_BUCKET:
        required: true

jobs:
  check-build-queue:
    runs-on: ubuntu-latest
    outputs:
      build_needed: ${{ steps.set-outputs.outputs.build_needed }}
      sha: ${{ steps.set-outputs.outputs.sha }}
      is_manual_build: ${{ steps.set-outputs.outputs.is_manual_build }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install boto3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Check build queue or add manual commit
        id: set-outputs
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          SOLVER="${{ inputs.solver }}"
          if [ -n "${{ inputs.commit_hash }}" ]; then
            COMMIT_HASH="${{ inputs.commit_hash }}"
            echo "Adding provided commit to build queue: $COMMIT_HASH"
            python scripts/scheduling/s3_state.py $SOLVER build-queue add "$COMMIT_HASH"
            echo "build_needed=true" >> $GITHUB_OUTPUT
            echo "sha=$COMMIT_HASH" >> $GITHUB_OUTPUT
            echo "is_manual_build=true" >> $GITHUB_OUTPUT
          else
            COMMIT_HASH=$(python scripts/scheduling/builder.py $SOLVER)
            if [ -n "$COMMIT_HASH" ]; then
              echo "build_needed=true" >> $GITHUB_OUTPUT
              echo "sha=$COMMIT_HASH" >> $GITHUB_OUTPUT
              echo "is_manual_build=false" >> $GITHUB_OUTPUT
            else
              echo "build_needed=false" >> $GITHUB_OUTPUT
              echo "sha=" >> $GITHUB_OUTPUT
              echo "is_manual_build=false" >> $GITHUB_OUTPUT
            fi
          fi

  build-static:
    needs: check-build-queue
    if: needs.check-build-queue.outputs.build_needed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Read solver config
        id: config
        run: |
          CONFIG="scripts/solvers/${{ inputs.solver }}/solver.json"
          echo "repo_url=$(jq -r '.repo_url' $CONFIG)" >> $GITHUB_OUTPUT
          echo "binary_path=$(jq -r '.binary_path' $CONFIG)" >> $GITHUB_OUTPUT

      - name: Prepare solver for commit
        run: |
          SOLVER="${{ inputs.solver }}"
          COMMIT_HASH="${{ needs.check-build-queue.outputs.sha }}"
          echo "Building commit: $COMMIT_HASH"
          if [ -d "$SOLVER" ]; then
            rm -rf "$SOLVER"
          fi
          git clone "${{ steps.config.outputs.repo_url }}" "$SOLVER"
          cd "$SOLVER"
          git checkout $COMMIT_HASH
          echo "Checked out commit: $(git rev-parse HEAD)"
          cd ..

      - name: Build static binary
        run: ./scripts/solvers/${{ inputs.solver }}/build.sh --static

      - name: Get commit hash
        id: get-commit
        working-directory: ${{ inputs.solver }}
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

      - name: Collect build artifacts (headers, binary, compile_commands)
        run: |
          ./scripts/shared/collect_build_artifacts.sh --solver ${{ inputs.solver }} ${{ inputs.solver }}/build .artifacts

      - name: Compress collected artifacts
        run: |
          cd .artifacts
          tar -czf ../${{ inputs.solver }}/build/artifacts.tar.gz .
          cd ..

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Check if commit is still in build queue
        id: check-queue
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          COMMIT_HASH="${{ steps.get-commit.outputs.commit_hash }}"
          CHECK_OUTPUT=$(python scripts/scheduling/s3_state.py ${{ inputs.solver }} build-queue check "$COMMIT_HASH" 2>&1)
          IN_QUEUE=$(echo "$CHECK_OUTPUT" | grep -E "^(true|false)$" | tail -1)
          if [ "$IN_QUEUE" = "true" ]; then
            echo "should_upload=true" >> $GITHUB_OUTPUT
          else
            echo "should_upload=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload production binary to S3
        if: steps.check-queue.outputs.should_upload == 'true'
        run: |
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key solvers/${{ inputs.solver }}/builds/v2/production/${{ steps.get-commit.outputs.commit_hash }}.tar.gz \
            --body ${{ inputs.solver }}/build/artifacts.tar.gz \
            --tagging "Type=Production"

      - name: Discard build (not in queue)
        if: steps.check-queue.outputs.should_upload == 'false'
        run: echo "Build discarded - commit was removed from queue"

  build-static-coverage:
    needs: check-build-queue
    if: needs.check-build-queue.outputs.build_needed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Read solver config
        id: config
        run: |
          CONFIG="scripts/solvers/${{ inputs.solver }}/solver.json"
          echo "repo_url=$(jq -r '.repo_url' $CONFIG)" >> $GITHUB_OUTPUT
          echo "binary_path=$(jq -r '.binary_path' $CONFIG)" >> $GITHUB_OUTPUT

      - name: Install LLVM/Clang 17
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: '17'

      - name: Add LLVM to PATH
        run: echo "${{ env.LLVM_PATH }}/bin" >> $GITHUB_PATH

      - name: Clean any previous build
        run: |
          if [ -d "${{ inputs.solver }}/build" ]; then
            rm -rf "${{ inputs.solver }}/build"
            echo "Cleaned previous build directory"
          fi

      - name: Prepare solver for commit
        run: |
          SOLVER="${{ inputs.solver }}"
          COMMIT_HASH="${{ needs.check-build-queue.outputs.sha }}"
          echo "Building commit: $COMMIT_HASH"
          if [ -d "$SOLVER" ]; then
            rm -rf "$SOLVER"
          fi
          git clone "${{ steps.config.outputs.repo_url }}" "$SOLVER"
          cd "$SOLVER"
          git checkout $COMMIT_HASH
          echo "Checked out commit: $(git rev-parse HEAD)"
          cd ..

      - name: Build static binary with coverage
        run: |
          # Use clang with GCC toolchain to generate clang-compatible compile_commands.json
          # while still producing GCC-format coverage data (needed for fastcov)
          export CXX="clang++ --gcc-toolchain=/usr"
          export CC="clang --gcc-toolchain=/usr"
          ./scripts/solvers/${{ inputs.solver }}/build.sh --static --coverage

      - name: Get commit hash
        id: get-commit
        working-directory: ${{ inputs.solver }}
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

      - name: Collect build artifacts (headers, binary, compile_commands)
        run: |
          ./scripts/shared/collect_build_artifacts.sh --solver ${{ inputs.solver }} ${{ inputs.solver }}/build .artifacts

      - name: Compress collected artifacts
        run: |
          cd .artifacts
          tar -czf ../${{ inputs.solver }}/build/artifacts.tar.gz .
          cd ..

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Check if commit is still in build queue (coverage)
        id: check-queue-coverage
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          COMMIT_HASH="${{ steps.get-commit.outputs.commit_hash }}"
          CHECK_OUTPUT=$(python scripts/scheduling/s3_state.py ${{ inputs.solver }} build-queue check "$COMMIT_HASH" 2>&1)
          IN_QUEUE=$(echo "$CHECK_OUTPUT" | grep -E "^(true|false)$" | tail -1)
          if [ "$IN_QUEUE" = "true" ]; then
            echo "should_upload=true" >> $GITHUB_OUTPUT
          else
            echo "should_upload=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage binary to S3
        if: steps.check-queue-coverage.outputs.should_upload == 'true'
        run: |
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key solvers/${{ inputs.solver }}/builds/v2/coverage/${{ steps.get-commit.outputs.commit_hash }}.tar.gz \
            --body ${{ inputs.solver }}/build/artifacts.tar.gz \
            --tagging "Type=Coverage"

      - name: Discard coverage build (not in queue)
        if: steps.check-queue-coverage.outputs.should_upload == 'false'
        run: echo "Coverage build discarded - commit was removed from queue"

  remove-from-queue:
    needs: [check-build-queue, build-static, build-static-coverage]
    if: |
      needs.build-static.result == 'success' &&
      needs.build-static-coverage.result == 'success' &&
      needs.check-build-queue.outputs.build_needed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install boto3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Remove commit from build queue
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          COMMIT_HASH="${{ needs.check-build-queue.outputs.sha }}"
          python scripts/scheduling/s3_state.py ${{ inputs.solver }} build-queue remove "$COMMIT_HASH"
          echo "Removed $COMMIT_HASH from build queue (both binaries uploaded)"

  remove-from-queue-on-failure:
    needs: [check-build-queue, build-static, build-static-coverage]
    if: |
      always() &&
      needs.check-build-queue.outputs.build_needed == 'true' &&
      (needs.build-static.result == 'failure' || needs.build-static-coverage.result == 'failure')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install boto3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Remove failed commit from build queue
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          COMMIT_HASH="${{ needs.check-build-queue.outputs.sha }}"
          echo "Build failed for commit $COMMIT_HASH, removing from queue to prevent infinite retries"
          python scripts/scheduling/s3_state.py ${{ inputs.solver }} build-queue remove "$COMMIT_HASH"
          echo "Removed failed commit $COMMIT_HASH from build queue"

  skip-build:
    needs: check-build-queue
    if: needs.check-build-queue.outputs.build_needed == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: No commits in queue
        run: echo "No commits in build queue - skipping build"

